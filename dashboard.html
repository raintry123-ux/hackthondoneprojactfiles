<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - College System</title>
    <style>
        /* All previous CSS remains exactly the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header.admin-header {
            background: linear-gradient(to right, #8b5cf6, #7c3aed);
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .user-role {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 16px;
            margin-top: 10px;
            display: inline-block;
            font-weight: 600;
        }
        
        .dashboard-content {
            padding: 30px;
        }

        /* Student Specific Styles */
        .student-section {
            display: block;
        }
        
        .admin-section {
            display: none;
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .user-info h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .info-item {
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .attendance-section {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .attendance-btn {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .attendance-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .attendance-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .attendance-status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .today-attendance {
            background: #fff7ed;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .monthly-stats {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e0f2fe;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #0369a1;
        }
        
        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .action-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            border-color: #6a11cb;
        }
        
        .action-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        /* Admin Specific Styles */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .admin-stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #8b5cf6;
            background: linear-gradient(135deg, #f0f4ff, #e0e7ff);
        }
        
        .admin-stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #7c3aed;
            margin-bottom: 10px;
        }
        
        .admin-stat-label {
            font-size: 16px;
            color: #64748b;
            font-weight: 600;
        }
        
        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .student-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #8b5cf6;
        }
        
        .search-box {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 20px;
            font-size: 16px;
        }

        /* Common Styles */
        .logout-btn {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .logout-btn:hover {
            opacity: 0.9;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 15px 0;
        }
        
        .calendar-day {
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .calendar-day.present {
            background: #d1fae5;
            color: #065f46;
            font-weight: bold;
        }
        
        .calendar-day.absent {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .calendar-day-header {
            font-weight: bold;
            background: #e2e8f0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .location-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }

        .location-allowed {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .location-denied {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .location-checking {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin: 20px 0;
        }

        .accuracy-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .retry-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
        }

        .retry-btn:hover {
            background: #2563eb;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header will be dynamically set based on user role -->
        <div class="header" id="pageHeader">
            <h1 id="headerTitle">Welcome to Dashboard</h1>
            <p id="headerSubtitle">College Attendance System</p>
            <div class="user-role" id="userRole">Loading...</div>
        </div>
        
        <div class="dashboard-content">
            <!-- STUDENT SECTION -->
            <div class="student-section" id="studentSection">
                <!-- Student Information -->
                <div class="user-info">
                    <h3>Student Information</h3>
                    <div class="info-item">
                        <strong>Email:</strong> <span id="userEmail">Loading...</span>
                    </div>
                    <div class="info-item">
                        <strong>Full Name:</strong> <span id="userName">Loading...</span>
                    </div>
                    <div class="info-item">
                        <strong>Phone:</strong> <span id="userPhone">Loading...</span>
                    </div>
                    <div class="info-item">
                        <strong>User ID:</strong> <span id="userId">Loading...</span>
                    </div>
                </div>
                
                <!-- Attendance Section -->
                <div class="attendance-section">
                    <h3>Mark Your Attendance</h3>
                    
                    <!-- Location Status -->
                    <div id="locationStatus" class="location-status location-checking">
                        <span id="locationText">Checking your location...</span>
                        <button class="retry-btn" onclick="checkLocation()" id="retryBtn" style="display: none;">Retry</button>
                        <div class="accuracy-info" id="accuracyInfo"></div>
                    </div>
                    
                    <button class="attendance-btn" id="markAttendanceBtn" onclick="markAttendance()" disabled>
                        Mark Today's Attendance
                    </button>
                    <div id="attendanceStatus" class="attendance-status"></div>
                    
                    <div id="todayAttendance" class="today-attendance" style="display: none;">
                        <h4>Today's Attendance</h4>
                        <p><strong>Time:</strong> <span id="attendanceTime"></span></p>
                        <p><strong>Date:</strong> <span id="attendanceDate"></span></p>
                        <p><strong>Status:</strong> <span style="color: green;">Present ✅</span></p>
                    </div>

                    <!-- Monthly Statistics -->
                    <div class="monthly-stats">
                        <h4>📊 This Month's Attendance</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="monthWorkingDays">0</div>
                                <div class="stat-label">Working Days</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="monthPresent">0</div>
                                <div class="stat-label">Present</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="monthAbsent">0</div>
                                <div class="stat-label">Absent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="monthPercentage">0%</div>
                                <div class="stat-label">Percentage</div>
                            </div>
                        </div>
                        
                        <!-- Monthly Calendar View -->
                        <div id="monthCalendar" style="margin-top: 20px;"></div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="actions">
                    <div class="action-card" onclick="viewProfile()">
                        <div class="action-icon">👤</div>
                        <h3>View Profile</h3>
                        <p>Check your personal information</p>
                    </div>
                    
                    <div class="action-card" onclick="viewAttendanceRecords()">
                        <div class="action-icon">📊</div>
                        <h3>Attendance Records</h3>
                        <p>View your attendance history</p>
                    </div>
                    
                    <div class="action-card" onclick="viewDetailedStats()">
                        <div class="action-icon">📈</div>
                        <h3>Detailed Statistics</h3>
                        <p>Charts and detailed analysis</p>
                    </div>
                </div>
            </div>

            <!-- ADMIN SECTION -->
            <div class="admin-section" id="adminSection">
                <!-- Admin Statistics -->
                <div class="admin-stats">
                    <div class="admin-stat-card">
                        <div class="admin-stat-number" id="totalStudents">0</div>
                        <div class="admin-stat-label">Total Students</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-number" id="totalAttendance">0</div>
                        <div class="admin-stat-label">Total Attendance</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-number" id="todayAttendanceCount">0</div>
                        <div class="admin-stat-label">Today's Attendance</div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="admin-stat-number" id="activeUsers">0</div>
                        <div class="admin-stat-label">Active Users</div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="admin-actions">
                    <div class="action-card" onclick="viewAllStudents()">
                        <div class="action-icon">👥</div>
                        <h3>Manage Students</h3>
                        <p>View and manage all students</p>
                    </div>
                    
                    <div class="action-card" onclick="viewAttendanceReport()">
                        <div class="action-icon">📊</div>
                        <h3>Attendance Reports</h3>
                        <p>Detailed attendance analytics</p>
                    </div>
                    
                    <div class="action-card" onclick="viewSystemStats()">
                        <div class="action-icon">📈</div>
                        <h3>System Statistics</h3>
                        <p>Overall system performance</p>
                    </div>
                </div>

                <!-- Students List -->
                <div id="adminStudentsList" style="margin-top: 30px;"></div>
            </div>
            
            <center>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </center>
        </div>
    </div>

    <!-- Student Modals -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <h2>Student Profile</h2>
            <div id="profileInfo"></div>
        </div>
    </div>

    <div id="recordsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('recordsModal')">&times;</span>
            <h2>Attendance Records</h2>
            <div id="attendanceRecords"></div>
        </div>
    </div>

    <div id="statsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('statsModal')">&times;</span>
            <h2>Detailed Statistics</h2>
            <div class="chart-container">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Admin Modals -->
    <div id="allStudentsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('allStudentsModal')">&times;</span>
            <h2>All Students</h2>
            <input type="text" id="searchStudent" class="search-box" placeholder="Search students...">
            <div id="allStudentsData"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAn2MiKH9C3CXd_UBFvgy_8rxiENBsiJpc",
            authDomain: "rainweblogin-pagedatabase.firebasestorage.app",
            projectId: "rainweblogin-pagedatabase",
            storageBucket: "rainweblogin-pagedatabase.firebasestorage.app",
            messagingSenderId: "205913357514",
            appId: "1:205913357514:web:d83813940596f85e3c4833",
            measurementId: "G-1LZD8HGKDP"
        };

        // Initialize Firebase
        let auth, db;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            console.error('Firebase initialization error:', error);
        }

        // Global variables
        let currentUser = null;
        let userData = null;
        let allAttendanceRecords = [];
        let allUsers = [];
        let allAttendance = [];
        let attendanceChart = null;

        // College location coordinates (Change these to your college coordinates)
        const COLLEGE_LOCATION = {
            latitude: 28.6129,  // Example: Delhi coordinates
            longitude: 77.2295
        };
        const ALLOWED_RADIUS = 100; // 100 meters radius

        // Check if user is logged in and load appropriate dashboard
        window.addEventListener('load', async function() {
            currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!currentUser || !currentUser.email) {
                window.location.href = 'index.html';
                return;
            }

            // Set dashboard type based on admin status
            if (currentUser.isAdmin) {
                showAdminDashboard();
                await loadAdminData();
            } else {
                showStudentDashboard();
                await loadStudentData();
                // Check location for students with better accuracy
                checkLocation();
            }
        });

        // Improved location checking with better accuracy
        function checkLocation() {
            const locationStatus = document.getElementById('locationStatus');
            const locationText = document.getElementById('locationText');
            const accuracyInfo = document.getElementById('accuracyInfo');
            const markBtn = document.getElementById('markAttendanceBtn');
            const retryBtn = document.getElementById('retryBtn');
            
            locationStatus.className = 'location-status location-checking';
            locationText.textContent = 'Getting precise location...';
            accuracyInfo.textContent = 'Using high accuracy GPS...';
            retryBtn.style.display = 'none';
            markBtn.disabled = true;

            if (!navigator.geolocation) {
                locationText.innerHTML = '❌ Geolocation is not supported by this browser.';
                accuracyInfo.textContent = 'Please use a modern browser with GPS support.';
                locationStatus.className = 'location-status location-denied';
                retryBtn.style.display = 'inline-block';
                return;
            }

            // First try: High accuracy with timeout
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    handleLocationSuccess(position);
                },
                function(error) {
                    // If high accuracy fails, try with lower accuracy
                    console.log('High accuracy failed, trying standard accuracy...');
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            handleLocationSuccess(position);
                        },
                        function(error) {
                            handleLocationError(error);
                        },
                        {
                            enableHighAccuracy: false,
                            timeout: 15000,
                            maximumAge: 60000
                        }
                    );
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function handleLocationSuccess(position) {
            const locationStatus = document.getElementById('locationStatus');
            const locationText = document.getElementById('locationText');
            const accuracyInfo = document.getElementById('accuracyInfo');
            const markBtn = document.getElementById('markAttendanceBtn');
            const retryBtn = document.getElementById('retryBtn');
            
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            const distance = calculateDistance(
                userLat, 
                userLng, 
                COLLEGE_LOCATION.latitude, 
                COLLEGE_LOCATION.longitude
            );
            
            // Show accuracy information
            accuracyInfo.textContent = `GPS Accuracy: ±${Math.round(accuracy)} meters | Distance: ${distance.toFixed(0)} meters from college`;
            
            if (distance <= ALLOWED_RADIUS) {
                locationText.innerHTML = '✅ You are within college premises.';
                locationStatus.className = 'location-status location-allowed';
                markBtn.disabled = false;
                
                // Additional accuracy check
                if (accuracy > 50) {
                    accuracyInfo.innerHTML += '<br>⚠️ Low GPS accuracy. Move to open area for better precision.';
                }
            } else {
                locationText.innerHTML = `❌ You are ${distance.toFixed(0)} meters away from college.`;
                locationStatus.className = 'location-status location-denied';
                markBtn.disabled = true;
                
                if (accuracy > 100) {
                    accuracyInfo.innerHTML += '<br>📍 GPS accuracy is low. Your actual location might be closer.';
                }
            }
            
            retryBtn.style.display = 'inline-block';
        }

        function handleLocationError(error) {
            const locationText = document.getElementById('locationText');
            const accuracyInfo = document.getElementById('accuracyInfo');
            const retryBtn = document.getElementById('retryBtn');
            
            let errorMessage = '❌ Unable to get your location. ';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Location access was denied. Please allow location permissions in your browser settings.';
                    accuracyInfo.textContent = 'Go to browser settings → Site permissions → Location → Allow';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable.';
                    accuracyInfo.textContent = 'Check if your device has GPS/Location services enabled';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out.';
                    accuracyInfo.textContent = 'Please try again in better network conditions';
                    break;
                default:
                    errorMessage += 'An unknown error occurred.';
                    accuracyInfo.textContent = 'Please refresh the page and try again';
                    break;
            }
            
            locationText.innerHTML = errorMessage;
            document.getElementById('locationStatus').className = 'location-status location-denied';
            retryBtn.style.display = 'inline-block';
        }

        // Calculate distance between two coordinates using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }

        // Show Student Dashboard
        function showStudentDashboard() {
            document.getElementById('pageHeader').classList.remove('admin-header');
            document.getElementById('headerTitle').textContent = 'Student Dashboard';
            document.getElementById('headerSubtitle').textContent = 'College Attendance System';
            document.getElementById('userRole').textContent = '👤 Student Account';
            
            document.getElementById('studentSection').style.display = 'block';
            document.getElementById('adminSection').style.display = 'none';
        }

        // Show Admin Dashboard
        function showAdminDashboard() {
            document.getElementById('pageHeader').classList.add('admin-header');
            document.getElementById('headerTitle').textContent = 'Admin Dashboard';
            document.getElementById('headerSubtitle').textContent = 'College Management System';
            document.getElementById('userRole').textContent = '👑 Administrator Account';
            
            document.getElementById('studentSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
        }

        // Load Student Data
        async function loadStudentData() {
            // Display basic user info
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userId').textContent = currentUser.uid || 'N/A';

            // Load user data from Firestore
            await loadUserData();
            
            // Load all attendance records
            await loadAllAttendanceRecords();
            
            // Check today's attendance
            await checkTodaysAttendance();

            // Calculate and display monthly statistics
            await calculateMonthlyStats();
        }

        // Load Admin Data
        async function loadAdminData() {
            try {
                // Load all users
                const usersQuery = await db.collection('users').get();
                allUsers = [];
                usersQuery.forEach(doc => {
                    allUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Load all attendance
                const attendanceQuery = await db.collection('attendance').get();
                allAttendance = [];
                attendanceQuery.forEach(doc => {
                    allAttendance.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Update admin statistics
                updateAdminStatistics();
                displayAdminStudentsList();
                
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // Update Admin Statistics
        function updateAdminStatistics() {
            const totalStudents = allUsers.filter(user => !user.isAdmin).length;
            const totalAttendance = allAttendance.length;
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = allAttendance.filter(record => record.date === today).length;
            const activeUsers = allUsers.length;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalAttendance').textContent = totalAttendance;
            document.getElementById('todayAttendanceCount').textContent = todayAttendance;
            document.getElementById('activeUsers').textContent = activeUsers;
        }

        // Display Admin Students List
        function displayAdminStudentsList() {
            const container = document.getElementById('adminStudentsList');
            const students = allUsers.filter(user => !user.isAdmin);
            
            let html = '<h3>Recent Students</h3>';
            
            students.slice(0, 5).forEach(student => {
                const studentAttendance = allAttendance.filter(record => record.userId === student.id);
                const today = new Date().toISOString().split('T')[0];
                const presentToday = studentAttendance.some(record => record.date === today);
                
                html += `
                    <div class="student-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold;">${student.fullName || 'Unknown'}</div>
                                <div style="color: #666; font-size: 14px;">${student.email}</div>
                            </div>
                            <div style="color: ${presentToday ? '#10b981' : '#ef4444'}; font-weight: bold;">
                                ${presentToday ? '✅ Present' : '❌ Absent'}
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #666;">
                            Total Records: ${studentAttendance.length} | Phone: ${student.phone || 'N/A'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Student Functions
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    document.getElementById('userName').textContent = userData.fullName || 'Not set';
                    document.getElementById('userPhone').textContent = userData.phone || 'Not set';
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function loadAllAttendanceRecords() {
            try {
                const attendanceQuery = await db.collection('attendance')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                allAttendanceRecords = [];
                attendanceQuery.forEach(doc => {
                    allAttendanceRecords.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                allAttendanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                
            } catch (error) {
                console.error('Error loading attendance records:', error);
            }
        }

        async function markAttendance() {
            const btn = document.getElementById('markAttendanceBtn');
            const statusDiv = document.getElementById('attendanceStatus');
            
            btn.innerHTML = '<span class="loading"></span> Verifying Location...';
            btn.disabled = true;
            
            try {
                // Get current location again to confirm with high accuracy
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        const distance = calculateDistance(
                            userLat, 
                            userLng, 
                            COLLEGE_LOCATION.latitude, 
                            COLLEGE_LOCATION.longitude
                        );
                        
                        if (distance > ALLOWED_RADIUS) {
                            statusDiv.innerHTML = `<span style="color: red;">❌ You are ${distance.toFixed(0)} meters away from college. Attendance not allowed.</span>`;
                            btn.innerHTML = 'Mark Today\'s Attendance';
                            checkLocation(); // Update location status
                            return;
                        }

                        // Additional accuracy check
                        if (accuracy > 50) {
                            statusDiv.innerHTML = '<span style="color: orange;">⚠️ Low GPS accuracy. Moving to open area might help.</span>';
                        }

                        // Proceed with attendance marking
                        btn.innerHTML = '<span class="loading"></span> Marking Attendance...';
                        
                        const now = new Date();
                        const attendanceData = {
                            userId: currentUser.uid,
                            email: currentUser.email,
                            fullName: userData?.fullName || 'Unknown',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            date: now.toISOString().split('T')[0],
                            time: now.toLocaleTimeString(),
                            day: now.toLocaleDateString('en-IN', { weekday: 'long' }),
                            status: 'present',
                            location: {
                                latitude: userLat,
                                longitude: userLng,
                                distance: distance,
                                accuracy: accuracy
                            }
                        };

                        await db.collection('attendance').add(attendanceData);
                        await loadAllAttendanceRecords();
                        
                        statusDiv.innerHTML = '<span style="color: green;">✅ Attendance marked successfully!</span>';
                        btn.style.display = 'none';
                        
                        document.getElementById('attendanceTime').textContent = attendanceData.time;
                        document.getElementById('attendanceDate').textContent = `${attendanceData.day}, ${attendanceData.date}`;
                        document.getElementById('todayAttendance').style.display = 'block';
                        
                        await calculateMonthlyStats();
                    },
                    function(error) {
                        console.error('Error getting location:', error);
                        statusDiv.innerHTML = '<span style="color: red;">❌ Unable to verify location. Attendance not marked.</span>';
                        btn.innerHTML = 'Mark Today\'s Attendance';
                        btn.disabled = true;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
                
            } catch (error) {
                console.error('Error marking attendance:', error);
                statusDiv.innerHTML = '<span style="color: red;">❌ Error marking attendance.</span>';
                btn.innerHTML = 'Mark Today\'s Attendance';
                btn.disabled = false;
            }
        }

        async function checkTodaysAttendance() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const todayRecord = allAttendanceRecords.find(record => record.date === today);
                
                if (todayRecord) {
                    document.getElementById('markAttendanceBtn').style.display = 'none';
                    document.getElementById('attendanceTime').textContent = todayRecord.time;
                    document.getElementById('attendanceDate').textContent = `${todayRecord.day}, ${todayRecord.date}`;
                    document.getElementById('todayAttendance').style.display = 'block';
                    document.getElementById('attendanceStatus').innerHTML = '<span style="color: green;">✅ Attendance already marked for today</span>';
                }
            } catch (error) {
                console.error('Error checking attendance:', error);
            }
        }

        async function calculateMonthlyStats() {
            try {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const monthRecords = allAttendanceRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate.getMonth() === currentMonth && recordDate.getFullYear() === currentYear;
                });
                
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                let workingDays = 0;
                
                for (let day = new Date(firstDay); day <= lastDay; day.setDate(day.getDate() + 1)) {
                    if (day.getDay() !== 0 && day.getDay() !== 6) {
                        workingDays++;
                    }
                }
                
                const presentDays = monthRecords.length;
                const absentDays = Math.max(0, workingDays - presentDays);
                const percentage = workingDays > 0 ? ((presentDays / workingDays) * 100).toFixed(1) : 0;
                
                document.getElementById('monthWorkingDays').textContent = workingDays;
                document.getElementById('monthPresent').textContent = presentDays;
                document.getElementById('monthAbsent').textContent = absentDays;
                document.getElementById('monthPercentage').textContent = percentage + '%';
                
                generateCalendarView(currentMonth, currentYear, monthRecords);
                
            } catch (error) {
                console.error('Error calculating monthly stats:', error);
            }
        }

        function generateCalendarView(month, year, records) {
            const calendarDiv = document.getElementById('monthCalendar');
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            let calendarHTML = '<div class="calendar">';
            
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            days.forEach(day => {
                calendarHTML += `<div class="calendar-day calendar-day-header">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay.getDay(); i++) {
                calendarHTML += '<div class="calendar-day"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isPresent = records.some(record => record.date === dateStr);
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                const isWeekend = new Date(year, month, day).getDay() === 0 || new Date(year, month, day).getDay() === 6;
                
                let dayClass = 'calendar-day';
                if (isPresent) dayClass += ' present';
                else if (!isWeekend && day <= new Date().getDate()) dayClass += ' absent';
                
                calendarHTML += `<div class="${dayClass}">${day}${isToday ? '📍' : ''}</div>`;
            }
            
            calendarHTML += '</div>';
            calendarDiv.innerHTML = calendarHTML;
        }

        // Admin Functions
        function viewAllStudents() {
            const modal = document.getElementById('allStudentsModal');
            modal.style.display = 'block';
            
            const students = allUsers.filter(user => !user.isAdmin);
            let html = '';
            
            students.forEach(student => {
                const studentAttendance = allAttendance.filter(record => record.userId === student.id);
                html += `
                    <div class="student-card">
                        <div style="font-weight: bold;">${student.fullName || 'Unknown'}</div>
                        <div style="color: #666;">${student.email} | Phone: ${student.phone || 'N/A'}</div>
                        <div style="margin-top: 8px; font-size: 14px;">
                            Total Attendance: ${studentAttendance.length} records
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('allStudentsData').innerHTML = html;
        }

        function viewAttendanceReport() {
            alert('Attendance report would be shown here with charts and analytics.');
        }

        function viewSystemStats() {
            alert('System statistics would be shown here.');
        }

        // Common Functions
        function viewProfile() {
            const modal = document.getElementById('profileModal');
            const profileInfo = document.getElementById('profileInfo');
            
            profileInfo.innerHTML = `
                <div style="line-height: 2;">
                    <p><strong>Email:</strong> ${currentUser.email}</p>
                    <p><strong>Full Name:</strong> ${userData?.fullName || 'Not set'}</p>
                    <p><strong>Phone:</strong> ${userData?.phone || 'Not set'}</p>
                    <p><strong>User ID:</strong> ${currentUser.uid}</p>
                    <p><strong>Total Attendance Records:</strong> ${allAttendanceRecords.length}</p>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        async function viewAttendanceRecords() {
            const modal = document.getElementById('recordsModal');
            const recordsDiv = document.getElementById('attendanceRecords');
            
            modal.style.display = 'block';
            
            try {
                if (allAttendanceRecords.length === 0) {
                    recordsDiv.innerHTML = '<p>No attendance records found.</p>';
                    return;
                }
                
                let recordsHTML = '<div style="max-height: 400px; overflow-y: auto;">';
                
                allAttendanceRecords.forEach(record => {
                    recordsHTML += `
                        <div class="student-card">
                            <p><strong>Date:</strong> ${record.day}, ${record.date}</p>
                            <p><strong>Time:</strong> ${record.time}</p>
                            <p><strong>Status:</strong> <span style="color: green;">PRESENT</span></p>
                        </div>
                    `;
                });
                
                recordsHTML += '</div>';
                recordsDiv.innerHTML = recordsHTML;
                
            } catch (error) {
                console.error('Error loading attendance records:', error);
                recordsDiv.innerHTML = '<p style="color: red;">Error loading records.</p>';
            }
        }

        function viewDetailedStats() {
            const modal = document.getElementById('statsModal');
            modal.style.display = 'block';
            
            // Create chart for detailed statistics
            createAttendanceChart();
        }

        function createAttendanceChart() {
            const ctx = document.getElementById('attendanceChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (attendanceChart) {
                attendanceChart.destroy();
            }
            
            // Prepare data for chart
            const monthlyData = {};
            allAttendanceRecords.forEach(record => {
                const date = new Date(record.date);
                const monthYear = `${date.toLocaleString('default', { month: 'short' })} ${date.getFullYear()}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = 0;
                }
                monthlyData[monthYear]++;
            });
            
            const labels = Object.keys(monthlyData);
            const data = Object.values(monthlyData);
            
            attendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Attendance Days',
                        data: data,
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days Present'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Attendance Trend'
                        }
                    }
                }
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            if (auth) {
                auth.signOut();
            }
            window.location.href = 'index.html?logout=true';
        }

        // Search functionality for admin
        document.getElementById('searchStudent').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const students = allUsers.filter(user => !user.isAdmin);
            const filteredStudents = students.filter(student => 
                student.fullName?.toLowerCase().includes(searchTerm) || 
                student.email?.toLowerCase().includes(searchTerm)
            );
            
            let html = '';
            filteredStudents.forEach(student => {
                const studentAttendance = allAttendance.filter(record => record.userId === student.id);
                html += `
                    <div class="student-card">
                        <div style="font-weight: bold;">${student.fullName || 'Unknown'}</div>
                        <div style="color: #666;">${student.email} | Phone: ${student.phone || 'N/A'}</div>
                        <div style="margin-top: 8px; font-size: 14px;">
                            Total Attendance: ${studentAttendance.length} records
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('allStudentsData').innerHTML = html;
        });
    </script>
</body>
</html>
